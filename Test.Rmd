---
title: "Testing different model configurations and specifications"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    toc_collapse: no
---

##  Cargar paquetes

```{r}
library(tidyverse)
```

# Probar especificacion del modelo

## Leer datos

```{r}
fish <- read_csv(file = "Test.csv", col_types = cols())
```

## Inspeccionar los datos

```{r}
skimr::skim(fish)
```

## Visualizar datos crudos por Comunidad y par RC

```{r}
ggplot(fish, aes(x = Year, y = Abundance, color = Zone, fill = Zone, shape = RC)) +
  geom_smooth(method = "lm", alpha = 0.1) +
  geom_point() +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  facet_wrap(Community ~ RC) +
  theme_bw()
```

## Calcular promedios por Ano, comunidad, RC y zona

```{r}
group_by(fish, Community, RC, Year, Zone) %>% 
  summarize(mean(Abundance))
```

## Calcular la diferencia entre antes y despues

```{r}
group_by(fish, Community, RC, Year, Zone) %>% 
  summarize(m = mean(Abundance)) %>% 
  spread(Year, m) %>% 
  magrittr::set_colnames(value = c("Community", "RC", "Zone", "Before", "After")) %>% 
  mutate(Diff = After - Before)
```

## Ajustar el modelo

```{r, results = 'asis'}
model1 <- mutate(fish, Year = as.factor(Year)) %>% 
  lm(Abundance ~ Year * Zone * RC + 0, data = .)

stargazer::stargazer(model1, type = "html", single.row = T)
```

## Probar el modelo

```{r}
data.frame(Year = as.factor(c(1, 1, 2, 2, 1, 1, 2, 2, 1, 1, 2, 2, 1, 1, 2, 2)),
           Community = c("A","A","A","A","A","A","A","A","B","B","B","B","B","B","B","B"),
           RC = c("AB", "AB", "AB", "AB", "CD", "CD", "CD", "CD", "EF", "EF", "EF", "EF", "GH", "GH", "GH", "GH"),
           Zone = c("Control", "Reserve")) %>% 
  mutate(mean = predict(object = model1, .))
```

Tiene sentido, el promedio predeciro corresponde con los observados de arriba. Carguemos datos nuevos que incluyen un tercer ano

# Probando el modelo con 3 anos

## Cargar datos

```{r}
fish <- read_csv(file = "Test2.csv", col_types = cols())
```

## Inspeccionar datos

```{r}
skimr::skim(fish)
```

## Visualizar datos crudos por Comunidad y par RC

```{r}
ggplot(fish, aes(x = Year, y = Abundance, color = Zone, fill = Zone, shape = RC)) +
  geom_smooth(method = "lm", alpha = 0.1) +
  geom_point() +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  facet_wrap(Community ~ RC) +
  theme_bw()
```

## Ajustar el nuevo modelo.

Tiene la misma estructura, pero los datos tienen 3 anos

```{r, results = 'asis'}
model1 <- mutate(fish, Year = as.factor(Year)) %>% 
  lm(Abundance ~ Year * Zone * RC + 0, data = .)

stargazer::stargazer(model1, type = "html", single.row = T)
```

## Probar el modelo

```{r}
data.frame(Year = as.factor(c(3)),
           Community = c("A"),
           RC = c("AB"),
           Zone = c("Control", "Reserve")) %>% 
  mutate(mean = predict(object = model1, .))
```

Las predicciones son correctas, pues coinciden con los valores promedios del tercer ano en los datos crudos:

```{r}
filter(fish, Year == 3) %>% 
  group_by(RC, Zone) %>% 
  summarize(mean = mean(Abundance))
```

## Visualicemos los efectos del modelo.

```{r}
broom::tidy(model1) %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0, color = "red", size = 1) +
  geom_point(fill = "steelblue", size = 4, shape = 21, color = "black") +
  coord_flip() +
  theme_classic()
```

# Probar efectos fijos por ano vs. pre-post

Usemos los mismos datos, pero solamente la comunidad A para comparar Pre-Post vs. Efectos fijos por ano

## Primero efectos fijos por ano:

```{r}
(test_results <- filter(fish, Community == "A") %>% 
  mutate(Year = as.factor(Year)) %>% 
  lm(Abundance ~ Year * Zone * RC + 0, data = .) %>% 
  broom::tidy())

ggplot(test_results, aes(x = term, y = estimate)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0, color = "red", size = 1) +
  geom_point(fill = "steelblue", size = 4, shape = 21, color = "black") +
  coord_flip() +
  theme_classic()
```

## Ahora modificando Ano para tener pre y post:

```{r}
(test_results <- filter(fish, Community == "A") %>% 
  mutate(Year = as.factor(ifelse(Year == 1, "A", "D"))) %>% 
  lm(Abundance ~ Year * Zone * RC + 0, data = .) %>% 
  broom::tidy())

ggplot(test_results, aes(x = term, y = estimate)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0, color = "red", size = 1) +
  geom_point(fill = "steelblue", size = 4, shape = 21, color = "black") +
  coord_flip() +
  theme_classic()
```

Perdemos los terminos del Ano2 = 10 y Ano3 = 15, Ano2:Reserva = 2 y Ano3:Reserva = 5, y terminamos con AnoD = 12.5 y AnoD:Reserva, que son los promedios entre los perdidos, respectivamente. Esta forma de modelarlo nos dice el efecto PROMEDIO de la reserva, que podria subestimar el efecto real. Es mejor usar los efectos fijos por ano.

Que pasa si tenemos reservas que comienzan en diferentes anos?

# Reservas con anos diferentes

```{r}
fish <- read_csv(file = "Test3.csv", col_types = cols())
```

```{r, fig.width = 4, fig.height = 8}
ggplot(fish, aes(x = Year, y = Abundance, color = Zone, fill = Zone, shape = RC)) +
  geom_smooth(method = "lm", alpha = 0.1) +
  geom_point() +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  facet_wrap(Community ~ RC, ncol = 1) +
  theme_bw()
```

```{r, results = 'asis'}
model1 <- mutate(fish, Year = as.factor(Year)) %>% 
  lm(Abundance ~ Year * Zone * RC + 0, data = .)

stargazer::stargazer(model1, type = "html", single.row = T)
```

```{r}
data.frame(Year = as.factor(c(3)),
           Community = c("A"),
           RC = c("AB"),
           Zone = c("Control", "Reserve")) %>% 
  mutate(mean = predict(object = model1, .))
```

```{r}
broom::tidy(model1) %>% 
  ggplot(aes(x = term, y = estimate)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0, color = "red", size = 1) +
  geom_point(fill = "steelblue", size = 4, shape = 21, color = "black") +
  coord_flip() +
  theme_classic()
```

Nada! Algunos coeficientes no pueden ser estimados, pero es normal. Los coeficientes estimados corresponden a valores que no existen. Por ejemplo, la reserva RC = AB existe en anos 1, 2 y 3. El valor de Ano5 para esta reserva es NA, porque la reserva no existe en ese punto en el tiempo.

# Como completar los datos?

```{r}
df <- read_csv(file = "Test4.csv", col_types = cols())
```


```{r}
skimr::skim(df)
```

```{r}

complete(df, Year, Community, Transect, nesting(Site, Zone, GenusSpecies), fill = list(Abundance = 0)) %>% 
  select(Year, Community, Site, Zone, Transect, GenusSpecies, Abundance) %>% 
  arrange(Year, Community, Site, Zone, Transect, GenusSpecies)

```

