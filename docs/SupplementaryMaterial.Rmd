---
title: "Effectiveness of community-based marine reserves in small-scale fisheries"
output:
  bookdown::pdf_document2:
    keep_tex: yes
    # template: template_sup.tex
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

options(knitr.table.format = "latex")
```

```{r}
suppressPackageStartupMessages({
  library(magrittr)
  library(tidyverse)
})
```

# Data

```{r load_data}
invert <- read.csv(file = here::here("data", "invertebrates.csv"),
                stringsAsFactors = F)

fish <- read.csv(file = here::here("data", "fish.csv"),
                stringsAsFactors = F)

conapesca <- read.csv(file = here::here("data", "conapesca.csv"),
                stringsAsFactors = F)
```

```{r}
invert %>% 
  group_by(ano, comunidad, zona, sitio, transecto) %>%
  count() %>%
  group_by(comunidad, zona) %>%
  count() %>% 
  spread(zona, nn) %>% 
  knitr::kable(caption = "Number of invertebrate transects performed in each site of each community.",
               col.names = c("Community", "Control", "Reserve"))
```

```{r}
invert %>%
  filter(generoespecie %in% c("Panulirus interruptus", "Panulirus argus")) %>% 
  group_by(rc, ano, year, comunidad, sitio, zona, transecto) %>% 
  summarize(indicador = sum(abundancia)/60) %>%
  ungroup() %>% 
  mutate(year = as.numeric(year)) %>% 
  ggplot(aes(x = year, y = indicador, color = zona, fill = zona, group)) +
  stat_summary(geom = "ribbon", fun.data = mean_se, alpha = 0.5) +
  stat_summary(geom = "line", fun.y = mean) +
  theme_minimal() +
  facet_wrap(~comunidad, scales = "free", ncol = 2) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  ylab(bquote("Density org m"^{-2})) +
  xlab("Year since implementation") +
  theme(legend.justification = c(0,0),
        legend.position = c(0.5, 0.15))
```


```{r}
invert %>%
  group_by(rc, ano, year, comunidad, sitio, zona, transecto, generoespecie) %>% 
  summarize(indicador = sum(abundancia)/60) %>%
  ungroup() %>% 
  mutate(year = as.numeric(year)) %>% 
  ggplot(aes(x = year, y = indicador, color = zona, fill = zona, group)) +
  stat_summary(geom = "ribbon", fun.data = mean_se, alpha = 0.5) +
  stat_summary(geom = "line", fun.y = mean) +
  theme_minimal() +
  facet_wrap(~comunidad, scales = "free", ncol = 2) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  ylab(bquote("Density org m"^{-2})) +
  xlab("Year since implementation") +
  theme(legend.justification = c(0,0),
        legend.position = c(0.5, 0.15))
```


```{r}
fish %>% 
  group_by(ano, comunidad, zona, sitio, transecto) %>%
  count() %>%
  group_by(comunidad, zona) %>%
  count() %>% 
  spread(zona, nn) %>% 
  knitr::kable(caption = "Number of fish transects performed in each site of each community.",
               col.names = c("Community", "Control", "Reserve"))
```

```{r}
fish %>%
  group_by(rc, ano, year, comunidad, sitio, zona, transecto, generoespecie) %>% 
  summarize(indicador = sum(abundancia)/60) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(year)) %>% 
  ggplot(aes(x = year, y = indicador, color = zona, fill = zona, group)) +
  stat_summary(geom = "ribbon", fun.data = mean_se, alpha = 0.5) +
  stat_summary(geom = "line", fun.y = mean) +
  theme_minimal() +
  facet_wrap(~comunidad, scales = "free", ncol = 2) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  ylab(bquote("Density org m"^{-2})) +
  xlab("Year since implementation") +
  theme(legend.justification = c(0,0),
        legend.position = c(0.5, 0.15))
```

```{r}
fish %>%
  group_by(rc, ano, year, comunidad, sitio, zona, transecto, generoespecie, talla, a, b) %>% 
  summarize(abundancia = sum(abundancia)/60) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(year),
         biomass = abundancia * a * (talla^b)/1000) %>% 
  ggplot(aes(x = year, y = biomass, color = zona, fill = zona, group)) +
  stat_summary(geom = "ribbon", fun.data = mean_se, alpha = 0.5) +
  stat_summary(geom = "line", fun.y = mean) +
  theme_minimal() +
  facet_wrap(~comunidad, scales = "free", ncol = 2) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  ylab(bquote("Biomass Kg m"^{-2})) +
  xlab("Year since implementation") +
  theme(legend.justification = c(0,0),
        legend.position = c(0.5, 0.15))
```


```{r}
load(here::here("data", "results", "results.RData"))
```

```{r}
supp_regtable <- function(models, caption = "", fs = "tiny", bio = T){
  
  labels <- c(
    "Lobster abundance",
    "Fish biomass",
    "Invertebrate abundance",
    "Invertebrate biomass")
  
  if(!bio){
    labels <- c(
      "Landings",
      "Revenues")
  }
  
  stargazer::stargazer(models,
                     omit = c(
                       "generoespecie",
                       "unidad"),
                     se = commarobust::makerobustseslist(models, type = "HC1"),
                     t.auto = T,
                     p.auto = T,
                     column.labels = labels,
                     dep.var.labels = "",
                     single.row = T,
                     omit.stat = c("f", "adj.rsq"),
                     title = caption,
                     header = F,
                     font.size = fs,
                     column.sep.width = "1pt")
}
```

```{r, results = "asis"}
list(L_IN, B_IN, Ni_IN, N_IN) %>% 
  supp_regtable(caption = "Coefficient estimates of biological indicators for Isla Natividad.")
```

```{r, results = "asis"}
list(L_ME, B_ME, Ni_ME, N_ME) %>% 
  supp_regtable(caption = "Coefficient estimates of biological indicators for Maria Elena.")
```

```{r, results = "asis"}
list(L_PH, B_PH, Ni_PH, N_PH) %>% 
  supp_regtable(caption = "Coefficient estimates of biological indicators for Punta Herrero.", fs = "small")
```

```{r, results = "asis"}
list(C_IN, V_IN) %>% 
  supp_regtable(caption = "Coefficient estimates of socioeconomic indicators Isla Natividad.", bio = F)
```

```{r, results = "asis"}
list(C_ME, V_ME) %>% 
  supp_regtable(caption = "Coefficient estimates of socioeconomic indicators for Maria Elena.", bio = F)
```
